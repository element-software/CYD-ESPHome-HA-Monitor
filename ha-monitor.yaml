# ==============================================================================
#  CYD 2.8" Vertical Clock - Minimal Working Config
#  Paste everything below after your captive_portal: line
# ==============================================================================
esphome:
  name: <YOUR_DEVICE_NAME> # Use the name you used when you added a device in ESPHome
  friendly_name: <YOUR_DEVICE_FRIENDLY_NAME> # Same as above

esp32:
  board: esp32dev
  framework:
    type: esp-idf

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: <YOUR_HA_API_KEY>  # This is auto-generated by ESPHome when you add a device, use the one that was provided

ota:
  - platform: esphome
    password: <YOUR_ESPHOME_PASSWORD> # This is auto-generated by ESPHome when you add a device, use the one that was provided

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "HA Monitor Fallback Hotspot"
    password: <ANY_PASSWORD> # Use a random string for this

captive_portal:

output:
  - platform: ledc
    pin: GPIO21
    id: backlight_pwm

light:
  - platform: monochromatic
    output: backlight_pwm
    name: Display Backlight
    id: backlight
    restore_mode: ALWAYS_ON
    default_transition_length: 0.5s

spi:
  - id: tft
    clk_pin: GPIO14
    mosi_pin: GPIO13
    miso_pin: GPIO12
  - id: touch
    clk_pin: GPIO25
    mosi_pin: GPIO32
    miso_pin: GPIO39

display:
  - platform: ili9xxx
    id: my_display
    model: ILI9341
    spi_id: tft
    cs_pin: GPIO15
    dc_pin: GPIO2
    auto_clear_enabled: false
    invert_colors: false
    color_order: RGB
    dimensions:
      width: 240
      height: 320
    transform:
      swap_xy: true
      mirror_y: true
      mirror_x: true

touchscreen:
  platform: xpt2046
  id: my_touchscreen
  spi_id: touch
  cs_pin: GPIO33
  calibration:
    x_min: 220
    x_max: 3756
    y_min: 394
    y_max: 3749
  transform:
    swap_xy: false
    mirror_x: true
    mirror_y: true

# --- FONTS ---
font:
  - file: "gfonts://Roboto"
    id: clock_font
    size: 48
    glyphs: '0123456789: '
  - file: "gfonts://Roboto"
    id: date_font
    size: 20
    glyphs: "0123456789/- abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"
  - file: "gfonts://Material Icons"
    id: icon_font
    size: 28
    glyphs: "\uea0b\ueffc\ue1ff\ue559\ue7fd\ue88a"
  - file: "gfonts://Roboto"
    id: state_font
    size: 18
    glyphs: '0123456789ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvwxyz .°%W-'
  - file: "gfonts://Roboto"
    id: label_font
    size: 11
    glyphs: "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz .°%-"


# --- TIME ---
time:
  - platform: homeassistant
    id: esptime
    on_time:
      - seconds: 0
        then:
          - lvgl.label.update:
              id: label_clock
              text: !lambda 'return id(esptime).now().strftime("%H:%M");'
          - lvgl.label.update:
              id: label_date
              text: !lambda |-
                static const char *const dias[] = {"Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"};
                auto now = id(esptime).now();
                return str_sprintf("%s %02d/%02d", dias[now.day_of_week - 1], now.day_of_month, now.month);

# --- DISPLAY PAGE CONFIG ---
lvgl:
  displays:
    - my_display
  touchscreens:
    - my_touchscreen
  pages:
    - id: main_page
      bg_color: 0x000000
      widgets:
        - label:
            id: label_clock
            text: "--:--"
            text_font: clock_font
            text_color: 0xFFFFFF
            align: TOP_MID
            y: 5
        - label:
            id: label_date
            text: "--- --/--"
            text_font: date_font
            text_color: 0xAAAAAA
            align: TOP_MID
            y: 55
        # ====== ROW 1 ======
        # --- R1C1: Energy Usage ---
        - obj:
            x: 2
            y: 100
            width: 117
            height: 68
            bg_opa: TRANSP
            border_width: 0
            radius: 0
            widgets:
              - label:
                  id: icon_energy
                  text: "\uea0b"
                  text_font: icon_font
                  text_color: 0xFFA500
                  align: LEFT_MID
                  x: 0
              - label:
                  text: "Energy"
                  text_font: label_font
                  text_color: 0xAAAAAA
                  align: LEFT_MID
                  x: 32
                  y: -10
              - label:
                  id: val_energy
                  text: "--"
                  text_font: state_font
                  text_color: 0xFFFFFF
                  align: LEFT_MID
                  x: 32
                  y: 10

        # --- R1C2: Front Door ---
        - obj:
            x: 121
            y: 100
            width: 117
            height: 68
            bg_opa: TRANSP
            border_width: 0
            radius: 0
            widgets:
              - label:
                  id: icon_front_door
                  text: "\ueffc"
                  text_font: icon_font
                  text_color: 0x888888
                  align: LEFT_MID
                  x: 0
              - label:
                  text: "Front Door"
                  text_font: label_font
                  text_color: 0xAAAAAA
                  align: LEFT_MID
                  x: 32
                  y: -10
              - label:
                  id: val_front_door
                  text: "--"
                  text_font: state_font
                  text_color: 0xFFFFFF
                  align: LEFT_MID
                  x: 32
                  y: 10

        # ====== ROW 2 ======
        # --- R2C1: Office Temp ---
        - obj:
            x: 2
            y: 170
            width: 117
            height: 68
            bg_opa: TRANSP
            border_width: 0
            radius: 0
            widgets:
              - label:
                  id: icon_office_temp
                  text: "\ue1ff"
                  text_font: icon_font
                  text_color: 0x00BFFF
                  align: LEFT_MID
                  x: 0
              - label:
                  text: "Office"
                  text_font: label_font
                  text_color: 0xAAAAAA
                  align: LEFT_MID
                  x: 32
                  y: -10
              - label:
                  id: val_office_temp
                  text: "--"
                  text_font: state_font
                  text_color: 0xFFFFFF
                  align: LEFT_MID
                  x: 32
                  y: 10

        # --- R2C2: Gate Door ---
        - obj:
            x: 121
            y: 170
            width: 117
            height: 68
            bg_opa: TRANSP
            border_width: 0
            radius: 0
            widgets:
              - label:
                  id: icon_gate_door
                  text: "\ue559"
                  text_font: icon_font
                  text_color: 0x888888
                  align: LEFT_MID
                  x: 0
              - label:
                  text: "Gate"
                  text_font: label_font
                  text_color: 0xAAAAAA
                  align: LEFT_MID
                  x: 32
                  y: -10
              - label:
                  id: val_gate_door
                  text: "--"
                  text_font: state_font
                  text_color: 0xFFFFFF
                  align: LEFT_MID
                  x: 32
                  y: 10

        # ====== ROW 3 ======
        # --- R3C1: Garden Person ---
        - obj:
            x: 2
            y: 240
            width: 117
            height: 68
            bg_opa: TRANSP
            border_width: 0
            radius: 0
            widgets:
              - label:
                  id: icon_garden
                  text: "\ue7fd"
                  text_font: icon_font
                  text_color: 0x888888
                  align: LEFT_MID
                  x: 0
              - label:
                  text: "Garden"
                  text_font: label_font
                  text_color: 0xAAAAAA
                  align: LEFT_MID
                  x: 32
                  y: -10
              - label:
                  id: val_garden
                  text: "--"
                  text_font: state_font
                  text_color: 0xFFFFFF
                  align: LEFT_MID
                  x: 32
                  y: 10

        # --- R3C2: Loft Access ---
        - obj:
            x: 121
            y: 240
            width: 117
            height: 68
            bg_opa: TRANSP
            border_width: 0
            radius: 0
            widgets:
              - label:
                  id: icon_loft
                  text: "\ue88a"
                  text_font: icon_font
                  text_color: 0x888888
                  align: LEFT_MID
                  x: 0
              - label:
                  text: "Loft"
                  text_font: label_font
                  text_color: 0xAAAAAA
                  align: LEFT_MID
                  x: 32
                  y: -10
              - label:
                  id: val_loft
                  text: "--"
                  text_font: state_font
                  text_color: 0xFFFFFF
                  align: LEFT_MID
                  x: 32
                  y: 10


# --- BINARY SENSOR CONFIG ---
binary_sensor:
  - platform: homeassistant
    id: ha_front_door
    entity_id: binary_sensor.front_door_sensor_contact
    publish_initial_state: true
    on_state:
      then:
        - lvgl.label.update:
            id: icon_front_door
            text_color: !lambda |-
              if (id(ha_front_door).state) return lv_color_hex(0xFF5252);
              return lv_color_hex(0x32CD32);
        - lvgl.label.update:
            id: val_front_door
            text: !lambda |-
              if (id(ha_front_door).state) return "Open";
              return "Closed";
            text_color: !lambda |-
              if (id(ha_front_door).state) return lv_color_hex(0xFF5252);
              return lv_color_hex(0x32CD32);

  - platform: homeassistant
    id: ha_gate_door
    entity_id: binary_sensor.gate_door_contact
    publish_initial_state: true
    on_state:
      then:
        - lvgl.label.update:
            id: icon_gate_door
            text_color: !lambda |-
              if (id(ha_gate_door).state) return lv_color_hex(0xFF5252);
              return lv_color_hex(0x32CD32);
        - lvgl.label.update:
            id: val_gate_door
            text: !lambda |-
              if (id(ha_gate_door).state) return "Open";
              return "Closed";
            text_color: !lambda |-
              if (id(ha_gate_door).state) return lv_color_hex(0xFF5252);
              return lv_color_hex(0x32CD32);

  - platform: homeassistant
    id: ha_garden
    entity_id: binary_sensor.garden_pano_person_occupancy
    publish_initial_state: true
    on_state:
      then:
        - lvgl.label.update:
            id: icon_garden
            text_color: !lambda |-
              if (id(ha_garden).state) return lv_color_hex(0xFF5252);
              return lv_color_hex(0x888888);
        - lvgl.label.update:
            id: val_garden
            text: !lambda |-
              if (id(ha_garden).state) return "Detected";
              return "Clear";
            text_color: !lambda |-
              if (id(ha_garden).state) return lv_color_hex(0xFF5252);
              return lv_color_hex(0x32CD32);

  - platform: homeassistant
    id: ha_loft
    entity_id: binary_sensor.loft_access_door_contact
    publish_initial_state: true
    on_state:
      then:
        - lvgl.label.update:
            id: icon_loft
            text_color: !lambda |-
              if (id(ha_loft).state) return lv_color_hex(0xFF5252);
              return lv_color_hex(0x32CD32);
        - lvgl.label.update:
            id: val_loft
            text: !lambda |-
              if (id(ha_loft).state) return "Open";
              return "Closed";
            text_color: !lambda |-
              if (id(ha_loft).state) return lv_color_hex(0xFF5252);
              return lv_color_hex(0x32CD32);

# --- NUMERIC SENSOR CONFIG ---
sensor:
  - platform: homeassistant
    id: ha_energy
    entity_id: sensor.whole_home_energy_usage
    on_value:
      then:
        - lvgl.label.update:
            id: val_energy
            text: !lambda |-
              return str_sprintf("%.0fW", x);
        - lvgl.label.update:
            id: icon_energy
            text_color: !lambda |-
              if (x > 5000) return lv_color_hex(0xFF0000);
              if (x > 3000) return lv_color_hex(0xFF5252);
              if (x > 1000) return lv_color_hex(0xFFA500);
              return lv_color_hex(0x32CD32);

  - platform: homeassistant
    id: ha_office_temp
    entity_id: sensor.office_presence_one_temperature
    on_value:
      then:
        - lvgl.label.update:
            id: val_office_temp
            text: !lambda |-
              return str_sprintf("%.1f°C", x);
        - lvgl.label.update:
            id: icon_office_temp
            text_color: !lambda |-
              if (x > 30) return lv_color_hex(0xFF5252);
              if (x > 25) return lv_color_hex(0xFFA500);
              if (x < 15) return lv_color_hex(0x00BFFF);
              return lv_color_hex(0x32CD32);
